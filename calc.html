<script>

function evalString(str){
	var productSum = evalSymbol(str, new Set(["/", "*"]));

	return evalSymbol(productSum, new Set(["+", "-"]))
}

function isNumberOrPeriod(str){
	return str == "." || !isNaN(parseInt(str))
}

function toString(number){
	var str = number.toString();

	
	return str;
}

function evalSymbol(str, operations){
	var stack = [];
	var i =0;

	while(i<str.length){
		var c = str[i];

		if(operations.has(c)){
			var operation = c;
			var right = "";

			i++;

			while(i<str.length){ // find right
				c = str[i];

				if(isNumberOrPeriod(c)){
					right += c;	
					i++;				
				}
				else {
					i--;
					break;
				}
			}

			var left = "";

			while(stack.length){
				c = stack.pop();

				if(isNumberOrPeriod(c)){
					left = c + left;
				}
				else{
					stack.push(c);
					break;
				}
			}

			if(operation == "*"){
				stack.push(toString(Number(left) * Number(right)));
			}
			else if(operation == "/"){
				stack.push(toString(Number(left) / Number(right)));
			}
			if(operation == "+"){
				stack.push(toString(Number(left) + Number(right)));
			}
			else if(operation == "-"){
				stack.push(toString(Number(left) - Number(right)));
			}

		}
		else{
			stack.push(c);
		}

		i++
	}

	return stack.join("")
}

function validate(str){
	var openCount = 0;

	for(var i=0; i<str.length; i++){
		if(str[i] == "("){
			openCount++;
		}
		else if(str[i] == ")"){
			openCount--;

			if(openCount < 0){
				return false;
			}
		}
	}

	return openCount == 0;
}

function calc(str){
	if(!validate(str)){
		throw new Error(`${str} is invalid.`);
	}

	var retVal = 0;
	var i=0;
	var stack = [];

	while(i<str.length){
		var c = str[i];

		if(c==")"){
			//found a close ....back track to the open
			var formula = "";
			var popped = stack.pop();

			//find left and right and do it
			while(popped != "("){
				formula = popped + formula;
				popped = stack.pop();
			}

			//back track to the function name

			stack.push(evalString(formula))
		}
		else if(c != " ") {
			stack.push(c);
		}


		i++;
	}

	return evalString(stack.join(""));

}

//push chars from left to right on to a stack
//think of the ( as starts and stops

["(5+10*2*2+3+(1*2))*(2+1)",
"((5+10*2*2+3+(1*2))*(2+1)+10.9*2)",
"(5+10*2*2+3+(1*2))*(2+1.33)"].forEach(function(it){
	var expected = eval(it);
	var actual = calc(it);
	
	console.log(expected == actual, expected, actual)
});


</script>
